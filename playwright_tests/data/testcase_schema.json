{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://grueneerde.com/schemas/testcase/v2.1",
  "title": "GE E-Commerce Testfall v2.1",
  "description": "Schema v2.1 für Testfälle im Grüne Erde E-Commerce Testing Framework. Kompatibel mit TestHubPro911 v2.1.0, Testpanda-Import und API-Austausch.",
  "type": "object",
  "required": ["schema_version", "test_id", "name", "category", "priority", "channels", "description", "preconditions", "steps", "author", "last_modified"],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^2\\.(0|1)\\.?\\d*$",
      "description": "Schema-Version des Testfall-Formats (2.0, 2.1.0, etc.)"
    },
    "test_id": {
      "type": "string",
      "pattern": "^TC-[A-Z]+-[A-Z0-9-]+$",
      "description": "Eindeutige Test-ID im Format TC-{KATEGORIE}-{NR}, z.B. TC-SMOKE-001, TC-SHIP-AT-POST-001, TC-PROMO-CART-PERCENT-001"
    },
    "name": {
      "type": "string",
      "description": "Kurzer, beschreibender Testname"
    },
    "category": {
      "type": "string",
      "enum": [
        "smoke",
        "critical-path",
        "warenkorb",
        "suche",
        "account",
        "versandarten",
        "warenkorb-promotions",
        "gutschein-sicherheit",
        "gutschein-checkout-flows",
        "versandkostenfrei",
        "produktkategorien",
        "mindestbestellwert",
        "mengenrabatt",
        "aktionspreis",
        "mitarbeiterrabatt",
        "bundle",
        "promo-kombinationen",
        "data-validation",
        "performance"
      ],
      "description": "Funktionale Testkategorie"
    },
    "priority": {
      "type": "string",
      "enum": ["P0", "P1", "P2"],
      "description": "Testpriorität: P0=Kritisch, P1=Hoch, P2=Mittel"
    },
    "status": {
      "type": "string",
      "enum": ["defined", "implemented", "passing", "failing", "skipped"],
      "default": "defined",
      "description": "Aktueller Implementierungsstatus"
    },
    "channels": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["AT", "DE", "CH"]
      },
      "minItems": 1,
      "description": "Verkaufskanäle, in denen der Test ausgeführt wird"
    },
    "author": {
      "type": "string",
      "description": "Wer hat den Testfall erstellt/zuletzt geändert"
    },
    "last_modified": {
      "type": "string",
      "format": "date",
      "description": "Letztes Änderungsdatum im Format YYYY-MM-DD"
    },
    "description": {
      "type": "string",
      "description": "Ausführliche Beschreibung des Testfalls"
    },
    "preconditions": {
      "type": "array",
      "items": {
        "oneOf": [
          { "type": "string" },
          {
            "type": "object",
            "required": ["check", "description"],
            "properties": {
              "check": { "type": "string", "description": "Eindeutiger Bezeichner der Vorbedingung" },
              "description": { "type": "string", "description": "Menschenlesbare Beschreibung" },
              "verify": {
                "type": "object",
                "additionalProperties": true,
                "properties": {
                  "action": { "type": "string", "enum": ["http_status", "element_visible", "element_not_visible", "api_call"] },
                  "url": { "type": "string" },
                  "selector": { "type": "string" },
                  "expected": {}
                }
              }
            }
          }
        ]
      },
      "description": "Vorbedingungen (String oder Objekt mit optionaler Verifikation)"
    },
    "promo_config": {
      "type": "object",
      "description": "Shopware Promotion-Konfiguration für diesen Testfall",
      "properties": {
        "name_frontend": { "type": "string" },
        "code_type": {
          "type": "string",
          "enum": ["manual_code", "automatic", "campaign_specific"]
        },
        "discount_type": {
          "type": "string",
          "enum": ["percentage", "absolute", "free_shipping"]
        },
        "discount_target": {
          "type": "string",
          "enum": ["cart", "shipping", "selected_products", "most_expensive"]
        },
        "discount_value": { "type": ["number", "null"] },
        "currency": {
          "type": "string",
          "enum": ["EUR", "CHF"]
        },
        "min_order_value": { "type": ["number", "null"] },
        "usage_total": { "type": ["integer", "null"] },
        "usage_per_customer": { "type": ["integer", "null"] },
        "shopware_rule": { "type": ["string", "null"] },
        "channels": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "test_data": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "name"],
        "properties": {
          "type": { "type": "string", "description": "Art der Testdaten (z.B. product, shipping, address, promo, amounts)" },
          "name": { "type": "string", "description": "Eindeutiger Name innerhalb des Typs (z.B. default, billing, shipping)" }
        },
        "additionalProperties": true
      },
      "description": "Typisierte Testdaten-Objekte"
    },
    "steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["step", "action", "expected"],
        "properties": {
          "step": {
            "type": "integer",
            "minimum": 1,
            "description": "Schrittnummer"
          },
          "action": {
            "type": "string",
            "description": "Auszuführende Aktion (Kurzform)"
          },
          "description": {
            "type": "string",
            "description": "Ausführliche Beschreibung des Schritts für manuelle Tester"
          },
          "expected": {
            "type": "string",
            "description": "Erwartetes Ergebnis dieses Schritts"
          },
          "selector_hint": {
            "type": "string",
            "description": "Selektor-Hinweis für Automatisierung"
          },
          "attachments": {
            "type": "array",
            "items": { "type": "string", "format": "uri" },
            "description": "URLs zu Screenshots oder Bildern"
          },
          "inputs": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["action"],
              "properties": {
                "action": { "type": "string", "enum": ["navigate", "fill", "select", "check", "uncheck", "click", "wait"] },
                "selector": { "type": "string" },
                "value": { "type": ["string", "number", "boolean"] },
                "value_ref": {
                  "type": "string",
                  "pattern": "^[a-z_][a-z0-9_]*:[a-z_][a-z0-9_]*\\.[a-z_][a-z0-9_]*$",
                  "description": "Referenz auf test_data (z.B. address:billing.street)"
                }
              }
            },
            "description": "Maschinell ausführbare Interaktionen"
          },
          "wait_for": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "enum": ["selector_visible", "selector_hidden", "url_contains", "selector_attribute", "form_valid"] },
              "selector": { "type": "string" },
              "value": { "type": "string" },
              "attribute": { "type": "string" },
              "timeout_ms": { "type": "integer", "default": 5000 },
              "description": { "type": "string" }
            },
            "description": "Explizite Wait-Strategie vor Assertions"
          },
          "assert": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "message"],
              "properties": {
                "type": { "type": "string", "enum": ["element_visible", "element_hidden", "element_contains_text", "element_matches_regex", "element_selected", "checkbox_checked", "field_value", "url_contains", "no_validation_errors", "page_contains_text"] },
                "selector": { "type": "string" },
                "expected": { "type": "string" },
                "pattern": { "type": "string" },
                "scope": { "type": "string" },
                "values": { "type": "array", "items": { "type": "string" } },
                "message": { "type": "string", "description": "Fehlermeldung bei fehlgeschlagener Assertion" }
              }
            },
            "description": "Maschinell prüfbare Assertions"
          },
          "capture": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "selector", "extract"],
              "properties": {
                "name": { "type": "string", "pattern": "^[a-z_][a-z0-9_]*$" },
                "selector": { "type": "string" },
                "extract": { "type": "string", "enum": ["text_content", "attribute", "input_value"] },
                "attribute_name": { "type": "string" },
                "description": { "type": "string" }
              }
            },
            "description": "Werte aus UI extrahieren für spätere Verwendung"
          },
          "reference_screenshots": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["url", "caption"],
              "properties": {
                "url": { "type": "string", "format": "uri" },
                "caption": { "type": "string" },
                "timing": { "type": "string", "enum": ["before", "after"], "default": "after" }
              }
            },
            "description": "Referenz-Screenshots zur Dokumentation"
          }
        }
      },
      "minItems": 1,
      "description": "Geordnete Testschritte mit Erwartungen"
    },
    "postconditions": {
      "type": "array",
      "items": {
        "oneOf": [
          { "type": "string" },
          {
            "type": "object",
            "required": ["check", "description"],
            "properties": {
              "check": { "type": "string" },
              "description": { "type": "string" },
              "verify": {
                "type": "object",
                "additionalProperties": true,
                "properties": {
                  "type": { "type": "string", "enum": ["captured_value_not_empty", "page_contains_text", "element_visible", "element_contains_text", "url_contains"] },
                  "capture_ref": { "type": "string" },
                  "values": { "type": "array", "items": { "type": "string" } },
                  "selector": { "type": "string" },
                  "expected": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "description": "Erwarteter Zustand nach dem Test (String oder Objekt mit Verifikation)"
    },
    "cleanup": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Aufräumaktionen nach Testausführung"
    },
    "screenshots": {
      "type": "object",
      "properties": {
        "on_failure": { "type": "boolean", "default": true, "description": "Screenshot bei fehlgeschlagenem Step" },
        "on_step": { "type": "array", "items": { "type": "integer", "minimum": 1 }, "description": "Step-Nummern für Screenshots" },
        "output_dir": { "type": "string", "description": "Ausgabepfad mit Platzhaltern" }
      },
      "description": "Screenshot-Strategie für automatisierte Tests"
    },
    "automation": {
      "type": "object",
      "description": "Mapping zu konkreten Test-Implementierungen",
      "properties": {
        "playwright": {
          "type": ["string", "null"],
          "description": "Pfad zur Playwright-Testdatei"
        },
        "cypress": {
          "type": ["string", "null"],
          "description": "Pfad zur Cypress-Testdatei"
        },
        "manual": {
          "type": "boolean",
          "description": "Ob manueller Test möglich ist"
        }
      }
    },
    "references": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "label": { "type": "string" },
          "url": { "type": "string", "format": "uri" }
        }
      },
      "description": "Referenzen zu Shopware-Regeln, Promotion-Templates etc."
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Freie Tags für Filterung und Gruppierung"
    }
  },
  "additionalProperties": false
}
